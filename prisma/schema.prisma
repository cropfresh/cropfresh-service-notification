// Prisma schema for Notification Service
// https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client"
    output   = "../src/generated/prisma"
}

datasource db {
    provider = "postgresql"
}

// ============================================================================
// Notification Models
// ============================================================================

/// Notification record for tracking sent notifications
model Notification {
    id             Int                 @id @default(autoincrement())
    notificationId String              @unique @map("notification_id") @db.VarChar(36)
    channel        NotificationChannel
    status         NotificationStatus  @default(PENDING)

    // Recipient
    userId      String? @map("user_id") @db.VarChar(36)
    phoneNumber String? @map("phone_number") @db.VarChar(20)

    // Content
    templateType TemplateType? @map("template_type")
    language     Language      @default(ENGLISH)
    subject      String?       @db.VarChar(255)
    body         String        @db.Text

    // Provider tracking
    providerMessageId String? @map("provider_message_id") @db.VarChar(100)
    errorMessage      String? @map("error_message") @db.Text

    // Reference (e.g., listing_id, order_id)
    referenceId   String? @map("reference_id") @db.VarChar(36)
    referenceType String? @map("reference_type") @db.VarChar(50)

    // Timestamps
    sentAt      DateTime? @map("sent_at")
    deliveredAt DateTime? @map("delivered_at")
    createdAt   DateTime  @default(now()) @map("created_at")
    updatedAt   DateTime  @updatedAt @map("updated_at")

    @@index([userId])
    @@index([phoneNumber])
    @@index([status])
    @@index([referenceId, referenceType])
    @@map("notifications")
}

/// Notification templates for multi-language support
model NotificationTemplate {
    id           Int                 @id @default(autoincrement())
    templateType TemplateType        @map("template_type")
    language     Language
    channel      NotificationChannel

    // Template content with placeholders like {{farmer_name}}, {{drop_point_name}}
    subject String? @db.VarChar(255)
    body    String  @db.Text

    // Metadata
    isActive  Boolean  @default(true) @map("is_active")
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@unique([templateType, language, channel])
    @@map("notification_templates")
}

/// User notification preferences
model NotificationPreference {
    id     Int    @id @default(autoincrement())
    userId String @unique @map("user_id") @db.VarChar(36)

    // Channel preferences
    smsEnabled   Boolean @default(true) @map("sms_enabled")
    pushEnabled  Boolean @default(true) @map("push_enabled")
    emailEnabled Boolean @default(false) @map("email_enabled")

    // Language preference
    language Language @default(ENGLISH)

    // Quiet hours (optional)
    quietStart String? @map("quiet_start") @db.VarChar(5) // HH:mm
    quietEnd   String? @map("quiet_end") @db.VarChar(5) // HH:mm

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("notification_preferences")
}

// ============================================================================
// Enums
// ============================================================================

enum NotificationChannel {
    SMS
    PUSH
    EMAIL
}

enum NotificationStatus {
    PENDING
    SENT
    DELIVERED
    FAILED
}

enum Language {
    ENGLISH
    KANNADA
    HINDI
    TAMIL
    TELUGU
}

enum TemplateType {
    // Existing types
    DROP_POINT_ASSIGNMENT
    DROP_POINT_CHANGE
    ORDER_CONFIRMATION
    DELIVERY_REMINDER
    PAYMENT_RECEIVED
    OTP
    // Story 3.8 - New notification types
    ORDER_MATCHED
    MATCH_EXPIRING
    ORDER_CANCELLED
    QUALITY_DISPUTE
    HAULER_EN_ROUTE
    PICKUP_COMPLETE
    DELIVERED
    MATCH_EXPIRED
    EDUCATIONAL_CONTENT
}

// Story 3.8 - Notification Level for preferences
enum NotificationLevel {
    ALL
    CRITICAL
    MUTE
}

// ============================================================================
// Story 3.8 - Farmer Notification Center Models
// ============================================================================

/// Farmer in-app notification (AC: 3)
model FarmerNotification {
    id        String       @id @default(uuid()) @db.VarChar(36)
    farmerId  String       @map("farmer_id") @db.VarChar(36)
    type      TemplateType
    title     String       @db.VarChar(200)
    body      String       @db.Text
    deeplink  String?      @db.VarChar(500)
    metadata  Json?
    isRead    Boolean      @default(false) @map("is_read")
    createdAt DateTime     @default(now()) @map("created_at")

    @@index([farmerId, createdAt(sort: Desc)])
    @@index([farmerId, isRead])
    @@map("farmer_notifications")
}

/// Extended preferences for Story 3.8 (AC: 4)
model FarmerNotificationPreferences {
    farmerId           String            @id @map("farmer_id") @db.VarChar(36)
    smsEnabled         Boolean           @default(true) @map("sms_enabled")
    pushEnabled        Boolean           @default(true) @map("push_enabled")
    quietHoursStart    String            @default("22:00") @map("quiet_hours_start") @db.VarChar(5)
    quietHoursEnd      String            @default("06:00") @map("quiet_hours_end") @db.VarChar(5)
    quietHoursEnabled  Boolean           @default(true) @map("quiet_hours_enabled")
    notificationLevel  NotificationLevel @default(ALL) @map("notification_level")
    orderUpdates       Boolean           @default(true) @map("order_updates")
    paymentAlerts      Boolean           @default(true) @map("payment_alerts")
    educationalContent Boolean           @default(true) @map("educational_content")
    updatedAt          DateTime          @updatedAt @map("updated_at")

    @@map("farmer_notification_preferences")
}

/// SMS delivery log for retry tracking (AC: 6)
model SmsDeliveryLog {
    id           String             @id @default(uuid()) @db.VarChar(36)
    farmerId     String             @map("farmer_id") @db.VarChar(36)
    phoneNumber  String             @map("phone_number") @db.VarChar(20)
    messageId    String?            @map("message_id") @db.VarChar(100)
    templateKey  String?            @map("template_key") @db.VarChar(100)
    status       NotificationStatus @default(PENDING)
    retryCount   Int                @default(0) @map("retry_count")
    sentAt       DateTime?          @map("sent_at")
    deliveredAt  DateTime?          @map("delivered_at")
    errorMessage String?            @map("error_message") @db.Text
    createdAt    DateTime           @default(now()) @map("created_at")

    @@index([farmerId])
    @@index([messageId])
    @@index([status])
    @@map("sms_delivery_log")
}

/// Device token for FCM push notifications (AC: 7)
model DeviceToken {
    id         String   @id @default(uuid()) @db.VarChar(36)
    farmerId   String   @map("farmer_id") @db.VarChar(36)
    fcmToken   String   @map("fcm_token") @db.Text
    deviceType String?  @map("device_type") @db.VarChar(20)
    isActive   Boolean  @default(true) @map("is_active")
    createdAt  DateTime @default(now()) @map("created_at")
    updatedAt  DateTime @updatedAt @map("updated_at")

    @@unique([farmerId, fcmToken])
    @@index([farmerId, isActive])
    @@map("device_tokens")
}
